import java.util.*;


// User Login Menu - Uses HashMap

class AccountVerifier {
    private Map<String, String> accounts = new HashMap<>();

    public void register() {
        Scanner scanner = new Scanner(System.in);

        System.out.println("\n=== Registration ===");
        System.out.print("Enter a username: ");
        String username = scanner.nextLine().trim();

        if (accounts.containsKey(username)) {
            System.out.println("Username already exists! Please choose another.");
            return;
        }

        System.out.print("Enter a password: ");
        String password = scanner.nextLine().trim();

        accounts.put(username, password);
        System.out.println("Registration successful for user: " + username);
    }

    public boolean login() {
        Scanner scanner = new Scanner(System.in);

        System.out.println("\n========== Login ==========");
        System.out.print("Enter your Username: ");
        String enteredUsername = scanner.nextLine();

        System.out.print("Enter your Password: ");
        String enteredPassword = scanner.nextLine();

        if (accounts.containsKey(enteredUsername) &&
            accounts.get(enteredUsername).equals(enteredPassword)) {
            System.out.println("Login successful! Welcome " + enteredUsername);
            return true;
        } else {
            System.out.println("Incorrect Username or Password!");
            return false;
        }
    }
}

  
  
// Error-handling: Checking for invalid inputs

class InputHelper {
    public static int safeIntInput(Scanner sc, int min, int max) {
        while (true) {
            try {
                System.out.print("Choose option: ");
                int num = Integer.parseInt(sc.nextLine());
                if (num < min || num > max) {
                    System.out.println("Invalid choice! Enter a number between " + min + " and " + max + ".");
                    continue;
                }
                return num;
            } catch (NumberFormatException e) {
                System.out.println("ERROR: Enter numbers only!");
            }
        }
    }
}



// Student Management - Uses Linked List

class Student {
    String name;
    Student next;

    public Student(String name) {
        this.name = name;
    }
}

class StudentList {
    private Student head;

    public void insert(String name, int index) {
        Student newNode = new Student(name);
        if (index == 0 || head == null) {
            newNode.next = head;
            head = newNode;
            return;
        }
        Student temp = head;
        int i = 0;
        while (temp.next != null && i < index - 1) {
            temp = temp.next;
            i++;
        }
        newNode.next = temp.next;
        temp.next = newNode;
    }

    public boolean remove(String name) {
        if (head == null) return false;
        if (head.name.equalsIgnoreCase(name)) {
            head = head.next;
            return true;
        }

        Student temp = head;
        while (temp.next != null) {
            if (temp.next.name.equalsIgnoreCase(name)) {
                temp.next = temp.next.next;
                return true;
            }
            temp = temp.next;
        }
        return false;
    }

    public boolean search(String name) {
        Student temp = head;
        while (temp != null) {
            if (temp.name.equalsIgnoreCase(name)) return true;
            temp = temp.next;
        }
        return false;
    }

    public void sort() {
        if (head == null) return;
        for (Student i = head; i != null; i = i.next) {
            for (Student j = i.next; j != null; j = j.next) {
                if (i.name.compareToIgnoreCase(j.name) > 0) {
                    String t = i.name;
                    i.name = j.name;
                    j.name = t;
                }
            }
        }
    }

    public int count() {
        int c = 0;
        Student temp = head;
        while (temp != null) {
            c++;
            temp = temp.next;
        }
        return c;
    }

    public void display() {
        System.out.println("\n--- Registered Student ---");
        Student temp = head;
        while (temp != null) {
            System.out.println("- " + temp.name);
            temp = temp.next;
        }
        System.out.println("Total: " + count());
    }
}



// Undo Operations - Uses Stack

class UndoAction {
    String description;
    Runnable undo;

    UndoAction(String description, Runnable undo) {
        this.description = description;
        this.undo = undo;
    }
}

class UndoStack {
    private Stack<UndoAction> stack = new Stack<>();

    public void push(UndoAction action) {
        stack.push(action);
    }

    public void undoLast() {
        if (stack.isEmpty()) {
            System.out.println("Nothing to undo.");
            return;
        }
        UndoAction act = stack.pop();
        act.undo.run();
        System.out.println("Undone: " + act.description);
    }

    public void display() {
        System.out.println("\n--- Undo History ---");
        if (stack.isEmpty()) {
            System.out.println("(empty)");
            return;
        }
        for (UndoAction a : stack) {
            System.out.println("- " + a.description);
        }
    }
}



// Submission Queue - Uses Queue

class Submission {
    String description;
    int priority;
    public Submission(String description, int priority) {
        this.description = description;
        this.priority = priority;
    }
    public String toString() {
        return description + " (P:" + priority + ")";
    }
}

class SubmissionQueue {
    private PriorityQueue<Submission> queue =
        new PriorityQueue<>((a, b) -> b.priority - a.priority);

    public void addSubmission(Submission t) {
        queue.add(t);
    }

    public Submission serve() {
        return queue.poll();
    }

    public Submission peek() {
        return queue.peek();
    }

    public void display() {
        System.out.println("\n--- Pending Submissions ---");
        if (queue.isEmpty()) {
            System.out.println("(none)");
            return;
        }
        for (Submission t : queue) {
            System.out.println("- " + t);
        }
    }
}



// Activities Catalog - Uses ArrayList

class ActivitiesCatalog {
    private ArrayList<String> activities = new ArrayList<>();

    public void addActivity(String s) {
        activities.add(s);
    }

    public boolean upgradeActivity(String oldName, String newName) {
        int i = activities.indexOf(oldName);
        if (i != -1) {
            activities.set(i, newName);
            return true;
        }
        return false;
    }

    public boolean removeActivity(String s) {
        return activities.remove(s);
    }

    public boolean search(String s) {
        return activities.contains(s);
    }

    public void sort() {
        Collections.sort(activities);
    }

    public void display() {
        System.out.println("\n--- Activities Catalog ---");
        for (String s : activities) {
            System.out.println("- " + s);
        }
        System.out.println("Total: " + activities.size());
    }
}



// Submenus Options and Actions

class MenuHandlers {

    public static void manageStudent(Scanner sc, StudentList student, UndoStack undo) {
        while (true) {
            System.out.println("\n----- STUDENT MANAGEMENT -----");
            System.out.println("1. Add Student");
            System.out.println("2. Remove Student");
            System.out.println("3. Search");
            System.out.println("4. Sort");
            System.out.println("5. Display All");
            System.out.println("6. Return to Main Menu");

            int p = InputHelper.safeIntInput(sc, 1, 6);

            switch (p) {
                case 1:
                    System.out.print("Enter name: ");
                    String name = sc.nextLine();
                    System.out.print("Enter index number: ");
                    int idx = InputHelper.safeIntInput(sc, 0, 999);

                    student.insert(name, idx);
                    undo.push(new UndoAction("Add Student " + name,
                            () -> student.remove(name)));
                    break;

                case 2:
                    System.out.print("Enter name: ");
                    name = sc.nextLine();
                    if (student.remove(name)) {
                        undo.push(new UndoAction("Remove Student " + name,
                                () -> student.insert(name, 0)));
                    } else {
                        System.out.println("Name not found.");
                    }
                    break;

                case 3:
                    System.out.print("Search name: ");
                    name = sc.nextLine();
                    System.out.println(student.search(name) ? "Found." : "Not found.");
                    break;

                case 4:
                    student.sort();
                    System.out.println("Sorted.");
                    break;

                case 5:
                    student.display();
                    break;

                case 6:
                    return;
            }
        }
    }

    public static void manageSubmissions(Scanner sc, SubmissionQueue submissions, UndoStack undo) {
        while (true) {
            System.out.println("\n----- SUBMISSIONS QUEUE -----");
            System.out.println("1. Add Submission");
            System.out.println("2. Serve Next");
            System.out.println("3. Peek Next");
            System.out.println("4. Display All");
            System.out.println("5. Return to Main Menu");

            int t = InputHelper.safeIntInput(sc, 1, 5);

            switch (t) {
                case 1:
                    System.out.print("Description: ");
                    String d = sc.nextLine();
                    System.out.print("Priority (1-10): ");
                    int pr = InputHelper.safeIntInput(sc, 1, 10);

                    Submission submission = new Submission(d, pr);
                    submissions.addSubmission(submission);

                    undo.push(new UndoAction("Add Submission " + d,
                            () -> submissions.serve()));
                    break;

                case 2:
                    Submission served = submissions.serve();
                    System.out.println(served == null ? "No submissions available." : "Served: " + served);
                    break;

                case 3:
                    Submission next = submissions.peek();
                    System.out.println(next == null ? "No submissions." : "Next: " + next);
                    break;

                case 4:
                    submissions.display();
                    break;

                case 5:
                    return;
            }
        }
    }

    public static void manageActivities(Scanner sc, ActivitiesCatalog activities, UndoStack undo) {
        while (true) {
            System.out.println("\n----- ACTIVITIES CATALOG -----");
            System.out.println("1. Add");
            System.out.println("2. Upgrade");
            System.out.println("3. Remove");
            System.out.println("4. Search");
            System.out.println("5. Sort");
            System.out.println("6. Display");
            System.out.println("7. Return to Main Menu");

            int s = InputHelper.safeIntInput(sc, 1, 7);

            switch (s) {
                case 1:
                    System.out.print("Activity name: ");
                    String name = sc.nextLine();
                    activities.addActivity(name);
                    undo.push(new UndoAction("Add Activity " + name,
                            () -> activities.removeActivity(name)));
                    break;

                case 2:
                    System.out.print("Old name: ");
                    String oldN = sc.nextLine();
                    System.out.print("New name: ");
                    String newN = sc.nextLine();
                    if (activities.upgradeActivity(oldN, newN)) {
                        undo.push(new UndoAction("Upgrade Activity " + oldN,
                                () -> activities.upgradeActivity(newN, oldN)));
                    } else {
                        System.out.println("Activity not found.");
                    }
                    break;

                case 3:
                    System.out.print("Name: ");
                    name = sc.nextLine();
                    if (activities.removeActivity(name)) {
                        undo.push(new UndoAction("Remove Activity " + name,
                                () -> activities.addActivity(name)));
                    } else {
                        System.out.println("Activity not found.");
                    }
                    break;

                case 4:
                    System.out.print("Search: ");
                    name = sc.nextLine();
                    System.out.println(activities.search(name) ? "Found." : "Not found.");
                    break;

                case 5:
                    activities.sort();
                    System.out.println("Sorted.");
                    break;

                case 6:
                    activities.display();
                    break;

                case 7:
                    return;
            }
        }
    }

    public static void manageUndo(Scanner sc, UndoStack undo) {
        while (true) {
            System.out.println("\n----- UNDO OPTIONS -----");
            System.out.println("1. Undo Recent");
            System.out.println("2. View Undo History");
            System.out.println("3. Return to Main Menu");

            int u = InputHelper.safeIntInput(sc, 1, 3);

            switch (u) {
                case 1:
                    undo.undoLast();
                    break;
                case 2:
                    undo.display();
                    break;
                case 3:
                    return;
            }
        }
    }
}



// Main Program

public class Main {
    public static void main(String[] args) {

        Scanner sc = new Scanner(System.in);
        StudentList student = new StudentList();
        SubmissionQueue submissions = new SubmissionQueue();
        ActivitiesCatalog activities = new ActivitiesCatalog();
        UndoStack undo = new UndoStack();
        AccountVerifier auth = new AccountVerifier();

        boolean authenticated = false;


while (true) {  


    // User Login

    while (!authenticated) {
        System.out.println("\n============ USER LOGIN MENU ============");
        System.out.println("1. Register");
        System.out.println("2. Login");
        System.out.println("3. Exit Program");

        int opt = InputHelper.safeIntInput(sc, 1, 3);

        switch (opt) {
            case 1:
                auth.register();
                break;
            case 2:
                authenticated = auth.login();
                break;
            case 3:
                System.out.println("Exiting...");
                return;
        }
    }



    // MAIN MENU PHASE

    while (authenticated) {
        System.out.println("\n---------------------------------------------------");
        System.out.println("-------------CLASSROOM MANAGEMENT SYSTEM-------------");
        System.out.println("-----------------------------------------------------");
        System.out.println("1. Manage Student");
        System.out.println("2. Submission Queue");
        System.out.println("3. Activities Catalog");
        System.out.println("4. Undo Options");
        System.out.println("5. Logout");
        System.out.println("6. Exit Program");

        int choice = InputHelper.safeIntInput(sc, 1, 6);

        switch (choice) {
            case 1: MenuHandlers.manageStudent(sc, student, undo); break;
            case 2: MenuHandlers.manageSubmissions(sc, submissions, undo); break;
            case 3: MenuHandlers.manageActivities(sc, activities, undo); break;
            case 4: MenuHandlers.manageUndo(sc, undo); break;

            case 5:
                System.out.println("You have been logged out.");
                authenticated = false;   
                break;

            case 6:
                System.out.println("Goodbye!");
                return;
                }
            }
        }
    }
}



